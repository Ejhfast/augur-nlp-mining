<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
        Remove this if you use the .htaccess -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <title>Augur</title>
        <meta name="description" content="Predict the future with fiction" />
        <meta name="author" content="Pranav Rajpurkar" />
        <meta name="viewport" content="width=device-width initial-scale=1.0 user-scalable=yes">

        <!--TODO: Replace favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
        <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,300,400italic,400,600italic,600,700italic,700,800italic,800" rel="stylesheet" type="text/css">
        <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css">

        <style>
			body, a, h1, h2, h3, h4, p {
				font-family: 'Open Sans';
			}

			a.list-group-item.active, a.list-group-item.active:hover, a.list-group-item.active:focus {
				z-index: 2;
				color: #fff;
				background-color: #FC4848;
				border-color: #FC4848;
			}

			.input-group-lg > .form-control, .input-group-lg > .input-group-addon, .input-group-lg > .input-group-btn > .btn {
				height: 56px;
				padding: 10px 16px;
				font-size: 18px;
				line-height: 1.33;
				border-radius: 36px;
			}
			.input-group .form-control:last-child, .input-group-addon:last-child, .input-group-btn:last-child>.btn, .input-group-btn:last-child>.dropdown-toggle, .input-group-btn:first-child>.btn:not(:first-child) {
			border-bottom-left-radius: 0;
			border-top-left-radius: 0;
			}
			.navbar {
				padding: 5px 0px;
				margin-bottom: 0px;
				background: none;
				border: none;
			}

			#header-brand {
				font-size: 25px;
				color: #FC4848;
			}

			#header-section {
				padding-top: 120px;
				padding-bottom: 240px;
				position: relative;
				overflow: hidden;
				color: white;
				background: deepskyblue
			}
        </style>
        <style>
			.card {
				border-bottom: 1px solid #000;
				width: 200px;
			}
            .progress{
                border-radius: 0px;
            }
        </style>
        <script src="/socket.io/socket.io.js"></script>
    </head>

    <body>
        <section id = "header-section">
            <div class ="container">
                <div class= "row">
                    <div class = "col-md-6">
                        <h1> Mining Fiction To Predict the Future </h1>
                        <h4> What do you see around you? </h4>
                        <form id = "wl" name="wordlist" action="/createwordlist" method="post">
                            <div class="input-group input-group-lg" id="header-src-wrap">
                                <input type="search" name="words" autocomplete="off" class="form-control" id="words">
                                <span class="input-group-btn">
                                    <button class="btn btn-default" type="submit">
                                        <span class="glyphicon glyphicon-search"></span>
                                    </button> </span>
                            </div>
                        </form>

                    </div>

                    <div class = "col-md-6">
                        <div id = "err">

                        </div>
                        <div id = "response">

                        </div>
                    </div>
                </div>
            </div>
        </section>
        <div id = "progress-showing">
            <div class="progress">
                <div class="progress-bar progress-bar-striped active"  role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
            </div>
        </div>

        <nav class="navbar navbar-default navbar-static-bottom" role="navigation">
            <div class="container">
                <p class="navbar-text">
                    Augur 2014
                </p>
                <a href="#">
                <p class="navbar-text" data-toggle="modal" data-target="#myModal">
                    Give Feedback
                    </button>
                </p></a>

            </div>
            <!-- Button trigger modal -->

            <!-- Modal -->
            <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                &times;
                            </button>
                            <h4 class="modal-title" id="myModalLabel">Feedback Form</h4>
                        </div>
                        <form id="feedback" action="/feedback" method="post" role="form">

                            <div class="modal-body">
                                <textarea name="feedbacktext" class="form-control" rows="3"></textarea>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">
                                    Close
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Send
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </nav>
    </body>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script>
		a = {}
		b = []
		dict = {}
		wordList = []
		var socket = io.connect('http://localhost');

		function processData(data) {
			data = data.toString('utf8')
			spl = data.split('\n');
			c = spl.map(function(element) {
				a = {}
				actions = element.split('\t')
				if (actions.length === 2) {
					a['start'] = actions[0]
					a['end'] = actions[1]
					a['frequency'] = 1
					a2 = (a['start'] + " " + a['end']).split(' ');
					chosen = wordList.filter(function(n) {
						return a2.indexOf(n) != -1
					});
					a['words'] = chosen
					return a
				}
			});
			c = c.filter(function(n) {
				return n != undefined
			});
			c = c.filter(function(element1) {
				var keep = true
				for (var i = 0; i < b.length; i++) {
					var element2 = b[i]
					if ((element1['start'] === element2['start']) && (element1['end'] === element2['end'])) {
						element2['frequency'] += 1
						return false
					}
				}
				return true
			});
			b = b.concat(c)
		}

		function compareByFreq(a, b) {
			if (a.frequency < b.frequency)
				return 1;
			if (a.frequency > b.frequency)
				return -1;
			return 0;
		}

		function saveWordList() {
			wordList = $('#words').val().toString('utf8').split(' ')
		}

		function showCard(obj) {
			var start = obj['start']
			var end = obj['end']
			var freq = obj['frequency']
			var words = JSON.stringify(obj['words'])
			$('#response').append('<div class = "card">' + '<div class = "start">' + start + '</div> <div class = "end">' + end + '</div><div class =  "freq">' + freq + '</div> <div class = "words"> ' + words + '</div></div>')
		}

		function showCards(arr) {
			$('#response').empty()
			arr.sort(compareByFreq);
			l = arr.length
			for (var i = 0; i < Math.min(2, l); i++) {
				showCard(arr[i])
			}
			//arr.forEach(showCard);
		}


		$('#wl').submit(function(event) {
			saveWordList()
			$.ajax({
				type : "POST",
				url : "/createwordlist",
				data : $("#wl").serialize() // serializes the form's elements.
			});
			socket.emit('wlsubmit')
			return false
		});

		socket.on('res', function(d2) {
			processData(d2)
			showCards(b)
			//$('#response').text(JSON.stringify(f));
		});
        var total = 10000
		socket.on('err', function(data) {
			var j = JSON.stringify(data)
			var k = parseInt(j.split(' ')[1])
			$('.progress-bar').css('width', k/(total/100) + '%').attr('aria-valuenow', k/(total/100));
			$('#err').text(j.split(' ')[1]);
		});

		socket.on('count', function(data){
		    total = data;
		    console.log(total)
            $('.progress-bar').attr('aria-valuemax', total);
		});
    </script>
</html>
